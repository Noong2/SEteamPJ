<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>TimeOfArrivalNavigation</title>
    <script src="https://kit.fontawesome.com/f97a5f4cb2.js" crossorigin="anonymous"></script>
    <!-- Google Maps 스크립트 추가 -->
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDEwk9kXhtEYtiFvNULgBDV2ShcCJlnZU0&libraries=places"></script>
    <!-- Naver Maps 스크립트 제거 -->
    <!-- <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=3bfe53j5op"></script> -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>

<body>
    <!-- home bar -->
    <header class="navbar">
        <div class="navbar_logo">
            <i class="fa-solid fa-map"></i>
            <a href="">TA Navigation</a>
        </div>
    </header>

    <!-- infobox=sidebar+mapbar 데이터 표시영역 -->
    <div class="infobox">
        <!-- search aside 검색 작업과 출력 작업 영역 -->
        <aside class="sidebar">

            <!-- search option setting 검색 옵션 설정 -->
            <div class="sidebar_optionArea">
                <div class="search_inputBox_area">
                    <div class="search_inputBox">
                        <li>
                            <span>출발지 입력</span>
                            <input id="startAddress" type="text">
                        </li>
                        <li>
                            <span>도착지 입력</span>
                            <input id="endAddress" type="text">
                        </li>
                    </div>
                </div>

                <div class="action_tab_area">
                    <div class="action_tab">
                        <button type="reset" id="resetButton">
                            <i class="fa-solid fa-rotate-right"></i>
                            <span>재설정</span>
                        </button>
                        <button type="button" id="search">
                            <span>길찾기</span>
                            <i class="fa-solid fa-angles-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- results list 검색 결과 목록 -->
            <div class="sidebar_resultsArea">
                <div class="sidebar_resultstext">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <span>검색 결과</span>
                </div>
                <!-- resultList 검색결과 목록 -->
                <div class="resultList"></div>
            </div>

        </aside>



        <!-- map section 지도 출력 영역-->
        <section class="mapbar">
            <!-- map view 지도 출력 -->
            <div class="viewMap">
                <div id="map"></div>

                <script>
                    var map;
                    var markers = [];
                    var startXy, endXy;

                    // 'search' 버튼 클릭 시 이벤트 핸들러
                    $('#search').on('click', function () {
                        // Clear previous markers
                        for (var i = 0; i < markers.length; i++) {
                            markers[i].setMap(null);
                        }
                        markers = [];

                        // Clear previous results
                        $('#startResult').text('');
                        $('#endResult').text('');

                        // 호출할 함수를 호출
                        searchAndDisplay();
                    });

                    // 'reset' 버튼 클릭 시 이벤트 핸들러
                    $('#resetButton').on('click', function () {
                        // 입력 필드 초기화
                        $('#startAddress').val('');
                        $('#endAddress').val('');

                        // 결과 텍스트 초기화
                        $('#startResult').text('');
                        $('#endResult').text('');

                        // Clear previous markers
                        for (var i = 0; i < markers.length; i++) {
                            markers[i].setMap(null);
                        }
                        markers = [];

                        // 초기 맵 리스트로 되돌리기
                        selectMapList();
                    });

                    // 출발지, 목적지 검색 및 표시 함수
                    function searchAndDisplay() {
                        // 사용자로부터 출발지와 목적지 주소를 입력받습니다.
                        var startAddress = $('#startAddress').val();
                        var endAddress = $('#endAddress').val();

                        // 출발지와 목적지를 검색하고 지도에 표시합니다.
                        geocodeAndDisplay(startAddress, 'start');
                        geocodeAndDisplay(endAddress, 'end');
                    }

                    // 주소를 좌표로 변환하고 지도에 표시하는 함수
                    function geocodeAndDisplay(address, type) {
                        var geocoder = new google.maps.Geocoder();
                        geocoder.geocode({
                            address: address
                        }, function (results, status) {
                            if (status === google.maps.GeocoderStatus.OK) {
                                var item = results[0].geometry.location;
                                insertCoordinates(item.lng(), item.lat(), type);
                            } else {
                                alert('주소를 찾을 수 없습니다.');
                            }
                        });
                    }

                    // 좌표를 지도에 표시하고 결과를 사이드바에 표시하는 함수
                    function insertCoordinates(longitude, latitude, type) {
                        var resultText = (type === 'start' ? '출발지: ' : '목적지: ') + longitude + ', ' + latitude;

                        if (type === 'start') {
                            startXy = { longitude: longitude, latitude: latitude };
                            $('#startResult').text(resultText);
                        } else {
                            endXy = { longitude: longitude, latitude: latitude };
                            $('#endResult').text(resultText);
                        }

                        if (!map) {
                            // Google Maps API를 초기화합니다.
                            map = new google.maps.Map(document.getElementById('map'), {
                                // center: { lat: latitude, lng: longitude },
                                zoom: 14
                            });
                        }

                        // 출발지와 목적지의 좌표를 기반으로 지도의 경계를 설정합니다.
                        var bounds = new google.maps.LatLngBounds();
                        bounds.extend(new google.maps.LatLng(startXy.latitude, startXy.longitude));
                        bounds.extend(new google.maps.LatLng(endXy.latitude, endXy.longitude));

                        // 지도의 중심과 경계를 설정하여 지도를 확대합니다.
                        map.fitBounds(bounds);

                        var marker = new google.maps.Marker({
                            map: map,
                            position: new google.maps.LatLng(latitude, longitude),
                        });

                        markers.push(marker);

                        var infoWindow = new google.maps.InfoWindow({
                            content: '<div><strong>' + (type === 'start' ? '출발지' : '목적지') + '</strong><br>경도: ' + longitude + ', 위도: ' + latitude + '</div>',
                        });

                        google.maps.event.addListener(marker, 'click', function () {
                            infoWindow.open(map, marker);
                        });
                    }

                    // 초기 맵 리스트를 Google Maps 좌표로 설정하는 함수
                    function selectMapList() {
                        map = new google.maps.Map(document.getElementById('map'), {
                            center: { lat: 37.3595704, lng: 127.105399 },
                            zoom: 10
                        });
                    }

                    // 페이지 로드 시 초기 맵 리스트 설정
                    selectMapList();
                </script>
            </div>
        </section>
    </div>
</body>

</html>